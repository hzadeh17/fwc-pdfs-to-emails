# Process Documentation

This document provides an overview of the process to convert **PDF documents** of emails released after the Flint Water Crisis into a **searchable database** of emails. The programming language used is Python. Files can be downloaded here: GITHUB LINK.

# Table of Contents
1. [Early Process](#early-process)
2. [Preparing PDFs](#preparing-pdfs)
3. [Making the database](#making-the-database)
4. [Read the output](#reading-the-output)

# Early process

## The problem: 400,000+ PDFs

<div style="float: right"><img src="img/michwebsite.png" width="150" alt="alttext"></div>

bla bla bl abla bla blabla bla blabla bla blabla bla blabla bla blabla bla bla Some of them were blurry bla bla bla bla bl abla bla blabla bla blabla bla blabla bla blabla bla blabla bla bla Some of them were blurry bla bla bla bla bl abla bla blabla bla blabla bla blabla bla blabla bla blabla bla bla Some of them were blurry bla bla 
<div ><img src="img/blurrypdf.png" width="150" alt="alttext"></div>

bla bla bla bla bla bla bla bla bla bla bla bla We looked at them and stuff bla bla bla bla bla bla 

<div ><img src="img/emailoutline2020.png" width="250" alt="alttext"></div>

### Input: PDF document<br>

<details>
<summary>Example PDF bookmark</summary>

[Click here to go to server PDF link.](http://s-lib007.lib.uiowa.edu/flint/pdf/bookmarks/deq20_b08_216_220.pdf)
<embed src="http://s-lib007.lib.uiowa.edu/flint/pdf/pages/deq20_b08_216_220.pdf" type="application/pdf" width="100%" height="700px">
</details>
<br>

## Preparing directories

# Preparing PDFs

ocr.py

Then, I split the large PDFs into smaller PDFs (bookmarks) and produced .txt pages.

```make_pdf_bookmarks.py``` splits larger PDFs into bookmarks by their bookmarks embedded within the files, outputting into the ```make_bookmarks/output_pdfs/pdf_bookmarks``` directory. And ```get_bookmarks_titles.py``` obtains the embedded titles of those bookmarks, outputting ```make_bookmarks/output_json/bookmark_titles.json```.

Next, ```make_pdf_pages.py``` splits these .pdf bookmarks into individual pages, which can then be converted into .txt pages with ```make_txt_pages.py```.

I produced a .json of bookmarks and all their pages with ```get_page_names.py``` outputted into ```make_bookmarks/output_json/page_names.json```

### Naming convention

Bookmark names were generated by combining the PDF name (e.g. "deq20") + the bookmark number ("b08") + the first and last pages of the bookmark ("216_220").

Example bookmark name: deq20_b08_216_220

Page names were generated by combining the bookmark name with the the page number of that bookmark ("1").

Example page name: deq20_b08_216_220_1

# Making the database

```python3 make_database/get_database.py``` runs 2 main functions:
<br>```get_emails``` : 
<br>```tag_duplicates``` :

- Input files: ```make_bookmarks/output_json/bookmark_pages.json``` and ```make_bookmarks/output_pdfs/txt_pages.json``
- Output file: ```make_database/files/emails.json```
- In-progress file: ```make_database/log/emails_ip_####.json```

# Reading the output

The database is in JSON format. Each email has a unique 5-digit ID, with 17 metadata fields. For example, take this email:

This email is converted into the following database row:

```json
"00045": {
        "text_full": "\n\nFrom: Stanton, Terry A. (Treasury)\n\nSent: Monday, April 15, 2013 1:16 PM\n\nTo: \u2018Kirk Pinho'\n\nSubject: RE: Flint and the Karegnondi Water Authority\nAttachments: Flint - KWA Approval.pdf\n\nSee attached Kirk.",
        "text_body": "\n\nSee attached Kirk.",
        "text_header": "\n\nFrom: Stanton, Terry A. (Treasury)\n\nSent: Monday, April 15, 2013 1:16 PM\n\nTo: \u2018Kirk Pinho'\n\nSubject: RE: Flint and the Karegnondi Water Authority\nAttachments: Flint - KWA Approval.pdf",
        "sender": "Stanton, Terry A",
        "recipients_to": [
            "Pinho, Kirk"
        ],
        "subject": "RE: Flint and the Karegnondi Water Authority",
        "attachments": [
            "Flint - KWA Approval.pdf"
        ],
        "recipients_cc": false,
        "timestamp": 1366049800,
        "email_n_in_bm": 49,
        "pages": [
            "treasury01_b04_0379_0503_018"
        ],
        "bookmark": "treasury01_b04_0379_0503",
        "pdf": "treasury01",
        "department": "treasury",
        "bookmark_title": "2013_APR",
        "on": false,
        "duplicates": [],
        "canonical": true
    }
```

```00045``` is the email ID. Every email identified in the database has a unique ID and corresponds to a unique set of database metadata.

There are 4 kinds of columns in this row.

### 1: Text<br>

There is a row for the full text of the email (```text_full```), as well as the part of text that contains the header (```text_header```) and the body of the email (```text_body```).

### 2: Location and characteristics of email

These rows tell you something about where the email is located and its characteristics.
First, `pages` gives you a list of page names (strings) that contain the text of this email. This page/these pages are contained within a `bookmark`, contained within a ```pdf```.
There are also lines to tell you what number email it is in the bookmark ```email_n_in_bm```.
There is a row to tell you whether the email has a ```On``` header ```{"on":true}``` or a ```From:``` header ```{"on":false}```.
And there is a row with how many ```null``` values are in these rows.

### 3: Header metadata<br>

There is a row for each field that can appear in the header of an email.

#### ```timestamp```

The timestamp of the e
mail in unix format, found in "Date:" or "Sent:" or in an "On..." line.

- A 10-digit unix code, e.g.: ```Tuesday, October 06, 2015 12:43 PM``` becomes ```1444153400```
- ```0```, which means there IS a timestamp in the email (a ```Date:``` or ```Sent:``` or ```On...``` line was found), but the code failed to convert it into a unix timestamp.
- ```false```, which means no timestamp line (a ```Date:``` or ```Sent:``` or ```On...```) could be found.

#### ```sender```

The sender of the email.

- A string with the standardized form of the name. E.g.: ```From: Brad Coulter``` becomes ```Coulter, Brad```
- ```false```, which means a sender line was found, but there was no value in front of it. This often happens when the header is read like this: ```\n\nFrom:\nSent:\nTo:\nSubject:\n\n```

#### ```recipients_to```

The recipient/s in the "To:" line of the email. Every email has at least one recipient, but for ```On:``` emails, we are unable to know from the header metadata alone who the recipient/s is/are. In this case, the ```recipients_to``` value is ```false```.

- A list of standardized names that appear in the ```To:``` line.
- ```false```, which means a ```To:``` line was not found because the header is ```On...``` type.
- ```null```, which means a ```To:``` line was not found, but the header is ```From:``` ... so there should be a ```To:``` recipient.
- ```[null]```, which means that a name was found in front of ```To:``` but the code failed to standardize it.

#### ```recipients_cc```

The recipient/s in the "Cc:" line of the email. Not every email has ```Cc:``` recipients. If there is no ```Cc:``` present, the ```recipients_cc``` value is ```false```.

- A list of standardized names that appear in the ```Cc:``` line.
- ```false```, which means a ```Cc:``` line was not found, which is okay!
- ```null```, which means a ```Cc:``` line was found, but the code failed to obtain or standardize the names.

#### ```subject```

The text in the ```Subject:``` line.

- A string that appears in the ```Subject:``` line.
- ```false```, which means a ```Subject:``` line was not found. This could be because ```{"on":true}```, which is okay. But if ```{"on":false}``` it is not okay!
- ```null```, which means a ```Subject:``` line was found, but the code failed to obtain the value.

#### ```attachments```

The text in the ```Attachments:``` line, which lists the name/s of the attachment/s to the email.<br>

- A list of strings that appear in the ```Attachments:``` line.
- ```false```, which means a ```Attachments:``` line was not found, which is okay!
- ```null```, which means a ```Attachments:``` line was found, but the code failed to obtain the value.

Voila!
